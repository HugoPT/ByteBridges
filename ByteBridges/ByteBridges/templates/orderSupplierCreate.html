{% extends 'forms.html' %} {% block formContent %} {% block formTitle %}
<h1 class="title">Criar nova Encomenda</h1>
{% endblock %}

<form
  class="allforms row"
  action="{% url 'orderSupplierCreate' %}"
  method="post"
>
  {% csrf_token %}

  <div class="form-field col-lg-6">
    <div class="mainbox">
      <div class="formDrop">
        <select id="supplier" name="idsupplier" class="dropstyle">
          <option class="dropOptions" value="" disabled selected>
            Escolha um Fornecedor
          </option>
          {% for s in suppliers %}
          <option class="dropOptions" value="{{ s.idsupplier }}">
            {{ s.name }}
          </option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div class="form-field col-lg-6">
    <div class="mainbox">
      <div class="formDrop">
        <select id="warehouse" name="idwarehouse" class="dropstyle">
          <option class="dropOptions" value="" disabled selected>
            Escolha um Armazém
          </option>
          {% for w in warehouses %}
          <option class="dropOptions" value="{{ w.idwarehouse }}">
            {{ w.name }}
          </option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div class="form-field col-lg-12">
    <label class="areaLabel" for="obs">Observações adicionais:</label>
    <textarea id="obs" class="input-text js-input" name="obs"></textarea><br />
  </div>

  <div class="form-field col-lg-12 submitBtn">
    <button
      type="button"
      class="submit-btn"
      data-bs-toggle="modal"
      data-bs-target="#exampleModalCenter"
    >
      Escolher Produtos
    </button>
  </div>
</form>
<!-- Table -->
<div class="ordertable">
  <table class="table" id="dataTable">
    <thead>
      <tr>
        <th scope="col">#</th>
        <th scope="col">Armazém</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal -->

<div
  class="modal fade"
  id="exampleModalCenter"
  tabindex="-1"
  role="dialog"
  aria-labelledby="modalTitle"
  aria-hidden="true"
>
  <div
    class="modal-dialog modal-dialog-centered"
    id="modalCenter"
    role="document"
  >
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Criar Encomenda</h5>
        <button
          type="button"
          class="close"
          data-bs-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row modalContent" id="dropdown-container">
          <!-- Initial Dropdowns -->
          {% for i in "1" %}
          <div class="col-md-4">
            <div class="form-field">
              <div class="mainbox">
                <div class="formDrop">
                  <select
                    id="families{{ i }}"
                    name="idfamilies{{ i }}"
                    class="dropstyle"
                    onchange="handleSelectChange(this)"
                  >
                    {% for f in families %}
                    <option class="dropOptions" value="{{ f.idfamily }}">
                      {{ f.name }}
                    </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>
          {% endfor %} {% for i in "1" %}
          <div class="col-md-4">
            <div class="form-field">
              <div class="mainbox">
                <div class="formDrop">
                  <div id="componentContainer1"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-field">
              <div class="mainbox">
                <div class="formDrop">
                  <div id="quantityinput1"></div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <button
          type="button"
          class="btn addMoreBtn"
          onclick="addMoreDropdowns()"
        >
          <i class="bx bx-plus-circle plusicon"></i> Adicionar mais
        </button>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <button
          type="button"
          class="btn btn-primary"
          data-bs-dismiss="modal"
          onclick="saveChanges()"
        >
          Salvar alterações
        </button>
      </div>
    </div>
  </div>
</div>

<script>
    var counter;
    function updateArticlesAndComponents(selectedValue) {
      console.log("Selected value:", selectedValue);
  }

  function handleSelectChange(selectElement) {
      var selectedValue = selectElement.value;
      callComponents(selectedValue);

      // Find the closest parent row of the select element
      var parentRow = $(selectElement).closest('.newrow');

      // Get the ID of the associated input
      var inputId = parentRow.find('.modalInput').attr('id');

      // Show the associated input by adjusting the style display
      $("#" + inputId).css('display', 'block');
  }

  function callComponents(familyId) {
      counter = $(".row.modalContent").length;
      $.ajax({
          url: "get_articles/",
          type: "GET",
          data: { family_id: familyId },
          success: function (data) {
              // Update the content in the component container
              var componentContainer = $("#componentContainer" + counter);
              componentContainer.empty(); // Clear previous content

              // Create a new select element with a unique identifier
              var newSelect = $("<select>", {
                  id: "compo" + counter,
                  name: "idcompo" + counter,
                  class: "dropstyle",
                  onchange: function () {
                      updateArticlesAndComponents(this.value);
                  },
                  style: "display: none;", // Initially hide the component dropdown
              });

              // Add the default option to the new select element
              newSelect.append("<option class='dropOptions' value='' disabled selected>Escolha um Componente</option>");

              // Append the new options to the new select element
              data.articles.forEach(function (article) {
                  newSelect.append("<option class='dropOptions' value='" + article.id + "'>" + article.name + "</option>");
              });

              // Append the new select element to the component container
              componentContainer.append(newSelect);

              // Create a new input element
              var newInput = $("<input>", {
                  type: "text",
                  id: "quantityInput" + counter,
                  name: "quantityInput" + counter,
                  class: "modalInput",
                  placeholder: "Enter quantity",
                  style: "display: none;", // Initially hide the input field
              });

              // Clear previous content and append the new input element to the quantity input container
              var quantityinput = $("#quantityinput" + counter);
              quantityinput.empty().append(newInput);

              // Show the component dropdown and input field
              newSelect.css('display', 'block');
              newInput.css('display', 'block');
          },
          error: function (error) {
              console.error("Error fetching components:", error);
          },
      });
  }

  function addMoreDropdowns() {
      // Increment the counter for creating unique IDs
      counter = $(".row.modalContent").length + 1;

      // Create a new row
      var newRow = $('<div class="row newrow modalContent"></div>');

      // Create a column for the family dropdown
      var familyColumn = $('<div class="col-md-4"></div>');
      var familyDropdown = $(
          '<div class="form-field"><div class="mainbox"><div class="formDrop">' +
          '<select id="families' +
          counter +
          '" name="idfamilies' +
          counter +
          '" class="dropstyle" onchange="handleSelectChange(this)">' +
          '<option class="dropOptions" value="" disabled selected>Escolha uma Família</option>' +
          '</select></div></div></div>'
      );

      // Append the options for families
      {% for f in families %}
          familyDropdown.find('select').append('<option class="dropOptions" value="{{ f.idfamily }}">{{ f.name }}</option>');
      {% endfor %}

      familyColumn.append(familyDropdown);
      newRow.append(familyColumn);

      // Create a column for the component dropdown
      var componentColumn = $('<div class="col-md-4"></div>');

      var componentDropdown = $("<div class='form-field'><div class='mainbox'><div class='formDrop'>" +
          "<div id='componentContainer" + counter + "'><select id='compo" + counter + "' name='idcompo" + counter + "' class='dropstyle' onchange='updateArticlesAndComponents(this.value)' style='display: none;'>" +
          "<option class='dropOptions' value='' disabled selected>Escolha um Componente</option></select></div></div></div></div>");

      // Append the new dropdown to the current column
      componentColumn.append(componentDropdown);

      // Append the new column to the new row
      newRow.append(componentColumn);

      // Create a column for the input field
      var inputColumn = $('<div class="col-md-4"></div>');
      // Create a new input element
      var newInput = $("<input>", {
          type: "text",
          id: "quantityInput" + counter,
          name: "quantityInput" + counter,
          class: "modalInput",
          placeholder: "Enter quantity",
          style: "display: none;",
      });

      // Append the new input element to the current column
      inputColumn.append(newInput);

      // Append the new column to the new row
      newRow.append(inputColumn);

      // Append the new row to the existing dropdown container
      $("#dropdown-container").append(newRow);
  }
       function saveChanges() {
        // Iterate through the dropdowns in the modal
        for (let i = 1; i <= 3; i++) {
          // Assuming you have 3 dropdowns, adjust accordingly
          let warehouseValue = $("#warehouse" + i).val();

          console.log("Selected value for warehouse " + i + ":", warehouseValue);

          // Check if a warehouse is selected
          if (warehouseValue !== "") {
            // Append a new row to the table with the selected warehouse value
            $("#dataTable tbody").append(
              "<tr>" +
                '<th scope="row">' +
                i +
                "</th>" +
                "<td>" +
                warehouseValue +
                "</td>" +
                "<td>Other data</td>" + // Add other data as needed
                "</tr>"
            );
          }
        }
      }
      //teste
</script>

{% endblock %}
